<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Email Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
    <script defer src="./admin.js"></script>
    <script defer src="./alpinejs.min.js"></script>
  </head>
  <body class="bg-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-10" x-data="dashboardApp()" x-init="init()">
      <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-semibold text-slate-800">Email Job Dashboard</h1>
          <p class="text-slate-500">Authenticate, manage outbound jobs, and trigger the sender.</p>
        </div>
      </header>

      <template x-if="!token">
        <section class="bg-white shadow rounded-lg p-6 w-full max-w-lg mx-auto">
          <h2 class="text-xl font-medium text-slate-700 mb-4">Log in</h2>
          <form @submit.prevent="login" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-600">Username</label>
              <input type="text" x-model.trim="loginForm.username" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600">Password</label>
              <input type="password" x-model.trim="loginForm.password" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" required />
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 rounded" x-bind:disabled="busy">
              <span x-show="!busy">Sign in</span>
              <span x-show="busy">Authenticating...</span>
            </button>
            <p class="text-sm text-red-600" x-text="error" x-show="error"></p>
          </form>
        </section>
      </template>

      <template x-if="token">
        <div class="space-y-8">
          <div class="bg-white shadow rounded-lg p-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-slate-600">Signed in as <span class="font-semibold" x-text="user?.username"></span></p>
              <p class="text-sm text-slate-500">Role: <span class="font-semibold capitalize" x-text="user?.role"></span></p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button class="px-4 py-2 rounded border border-indigo-500 text-indigo-600" @click="refreshProfile" x-bind:disabled="busy">Refresh profile</button>
              <button class="px-4 py-2 rounded bg-rose-500 text-white" @click="logout">Logout</button>
            </div>
          </div>

          <section class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-slate-700">Create email job</h2>
              <span class="text-sm text-slate-400" x-show="busy">Working...</span>
            </div>
            <form class="grid gap-4" @submit.prevent="createJob">
              <div>
                <label class="block text-sm font-medium text-slate-600">From name</label>
                <input type="text" x-model.trim="form.fromName" placeholder="Marketing Team" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" required />
                <p class="text-xs text-slate-400 mt-1">Set the display name <small>(This is what your recievers will see as the name that sent.)</small>.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600">Reply-To (optional)</label>
                <input type="email" x-model.trim="form.replyTo" placeholder="reply@example.com" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600">Subject</label>
                <input type="text" x-model.trim="form.subject" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600">BCC/ Recipients</label>
                <textarea
                  rows="2"
                  x-model="form.recipients"
                  placeholder="one@example.com two@example.com three@example.com"
                  class="mt-1 w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200"
                  required></textarea>
                <p class="text-xs text-slate-400 mt-1">Separate addresses with spaces, commas, semicolons, or new lines.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600">HTML body/ Plain Text</label>
                <textarea
                  rows="10"
                  dir="ltr"
                  x-model="form.htmlBody"
                  placeholder="Write or paste your HTML email here"
                  class="mt-1 w-full rounded border border-slate-300 px-3 py-3 focus:outline-none focus:ring focus:ring-indigo-200 font-mono text-sm"
                  style="min-height: 220px;"></textarea>
                <p class="text-xs text-slate-400 mt-1">Drop your HTML template or plain text here.</p>
              </div>
              <button type="submit" class="self-start bg-indigo-600 text-white font-medium px-6 py-2 rounded hover:bg-indigo-500" x-bind:disabled="busy">
                Save job
              </button>
              <p class="text-sm text-green-600" x-text="message" x-show="message"></p>
              <p class="text-sm text-red-600" x-text="error" x-show="error"></p>
            </form>
          </section>

          <section class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-slate-700">Existing jobs</h2>
              <button class="text-sm text-indigo-600" @click="fetchJobs">Reload</button>
            </div>
            <template x-if="!jobs.length">
              <p class="text-slate-500">No jobs yet. Submit the form above to create one.</p>
            </template>
            <div class="overflow-x-auto" x-show="jobs.length">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-500 border-b">
                    <th class="py-2 pr-4">Subject</th>
                    <th class="py-2 pr-4">From</th>
                    <th class="py-2 pr-4">Recipients</th>
                    <th class="py-2 pr-4">Status</th>
                    <th class="py-2 pr-4">Summary</th>
                    <th class="py-2 pr-4">Owner</th>
                    <th class="py-2 pr-4">Updated</th>
                    <th class="py-2 pr-4">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="job in jobs" :key="job.id">
                    <tr class="border-b last:border-b-0">
                      <td class="py-2 pr-4 font-medium text-slate-700" x-text="job.subject"></td>
                      <td class="py-2 pr-4 text-slate-500">
                        <span x-text="job.fromName || job.from || 'Admin default'"></span>
                      </td>
                      <td class="py-2 pr-4 text-slate-500">
                        <span x-text="(job.recipientsPreview || job.recipients || []).join(', ')"></span>
                        <span class="text-xs text-slate-400" x-text="job.recipientsCount ? `(${job.recipientsCount} total)` : ''"></span>
                      </td>
                      <td class="py-2 pr-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                              :class="{
                                'bg-green-100 text-green-700': job.status === 'sent',
                                'bg-yellow-100 text-yellow-700': job.status === 'pending',
                                'bg-red-100 text-red-700': job.status === 'failed',
                                'bg-blue-100 text-blue-700': job.status === 'sending'
                              }">
                          <span class="mr-1">&#9679;</span>
                          <span x-text="job.status"></span>
                        </span>
                      </td>
                      <td class="py-2 pr-4 text-slate-600" x-text="formatJobSummary(job)"></td>
                      <td class="py-2 pr-4 text-slate-500" x-text="job.owner"></td>
                      <td class="py-2 pr-4 text-slate-500" x-text="formatDate(job.updatedAt)"></td>
                      <td class="py-2 pr-4 flex gap-2 flex-wrap">
                        <button class="px-3 py-1 bg-emerald-500 text-white rounded disabled:opacity-60 disabled:cursor-not-allowed"
                                @click="triggerSend(job.id)"
                                :disabled="job.status === 'sending'">Send</button>
                        <button class="px-3 py-1 bg-rose-500 text-white rounded" @click="deleteJob(job.id)" x-show="!isAdmin">Delete</button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </section>

        </div>
      </template>
    </div>
  </body>
</html>
